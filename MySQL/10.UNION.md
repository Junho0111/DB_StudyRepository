# SQL - 집합 연산자 (UNION)

### 1. 집합 연산자의 개념

집합 연산자는 여러 개의 `SELECT` 문 결과를 하나로 합치고 싶을 때 사용. `JOIN`이 여러 테이블을 옆으로(수평으로) 붙이는 것이라면, `UNION`은 위아래로(수직으로) 쌓는 개념.

<br>

### 2. UNION vs UNION ALL
| 구분 | 명령어 | 특징 | 성능 |
| --- | --- | --- | --- |
| **UNION** | `SELECT ... UNION SELECT ...` | **중복된 행을 제거**하고 고유한 행만 보여줌. | 중복 제거 과정(정렬 등)이 있어 상대적으로 느림. |
| **UNION ALL** | `SELECT ... UNION ALL SELECT ...` | **중복을 포함**하여 모든 결과 행을 그대로 합침. | 별도의 처리 없이 합치기만 하므로 빠름. |

* **팁**: 실무에서는 중복 제거가 꼭 필요한 상황이 아니라면 성능상 유리한 `UNION ALL`을 더 권장.

<br>

### 3. 집합 연산의 필수 조건 (규칙)

`UNION`을 사용하기 위해서는 합치려는 두 쿼리가 다음 조건을 반드시 만족해야함. 그렇지 않으면 SQL 에러가 발생.

1. **컬럼의 개수**: 합치려는 모든 `SELECT` 문의 컬럼 개수가 동일해야함.
2. **데이터 타입**: 대응되는 컬럼끼리는 데이터 타입이 서로 호환되어야함. (예: 첫 번째 쿼리의 1번 컬럼이 숫자면, 두 번째 쿼리의 1번 컬럼도 숫자여야 함)
3. **순서**: 컬럼의 순서가 일치해야 논리적으로 맞는 결과가 나옴.

<br>

### 4. 정렬 (ORDER BY) 사용법

`UNION` 결과 전체를 정렬하고 싶을 때는 **가장 마지막 `SELECT` 문 뒤에 단 한 번만** `ORDER BY`를 사용.

```sql
-- 잘못된 예시: 각 SELECT 문마다 ORDER BY를 쓰면 에러 발생 가능
-- 올바른 예시: 마지막에 통합 정렬
SELECT id, name FROM products
UNION
SELECT id, name FROM services
ORDER BY name; -- 전체 결과에 대해 이름순 정렬
```

<br>

### 5. 시나리오별 사용 예시 (Scenario & Example)

* **UNION ALL (수직적 결합)**: "서로 다른 테이블에 흩어져 있는 회원 명단을 하나로 통합 조회"
```sql
-- 국내 회원과 해외 회원 명단을 중복 상관없이 모두 합쳐서 출력
SELECT name, email FROM local_member
UNION ALL
SELECT name, email FROM global_member;

```
<br>

* **UNION (중복 제거)**: "여러 이벤트 응모자 중 중복을 제외한 당첨 대상자 명단 추출"
```sql
-- A 이벤트와 B 이벤트 중복 참여자도 한 번만 나오도록 합침
SELECT user_id FROM event_a_entry
UNION
SELECT user_id FROM event_b_entry;

```
<br>

* **가상 컬럼 활용**: "출처 테이블이 다르더라도 어떤 데이터인지 구분값을 주어 통합"
```sql
-- 상품 테이블과 서비스 테이블을 합치되, '구분' 컬럼을 추가함
SELECT id, name, 'PRODUCT' AS type FROM products
UNION ALL
SELECT id, name, 'SERVICE' AS type FROM services;

```
<br>

* **통합 정렬**: "합쳐진 전체 결과물에 대해 최신순으로 정렬"
```sql
SELECT name, created_at FROM orders
UNION ALL
SELECT name, created_at FROM refunds
ORDER BY created_at DESC; -- 마지막 쿼리 뒤에 한 번만 작성함

```
<br>

### 6. 실무 포인트

* **수평적 결합 vs 수직적 결합**: `JOIN`은 연관된 정보를 보강할 때(옆으로), `UNION`은 서로 다른 출처의 데이터를 한 명단으로 만들 때(밑으로) 사용한다는 차이를 명확히 이해해야함.
* **별칭(Alias) 결정**: 결과의 컬럼명은 **첫 번째 `SELECT` 문에서 지정한 이름**을 따름.
* **성능 고려**: 수만 건 이상의 대량 데이터를 합칠 때는 `UNION`의 중복 제거 작업이 큰 부하를 줄 수 있으므로, 데이터 성격을 파악하여 `UNION ALL` 사용 여부를 결정해야함.