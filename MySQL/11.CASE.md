# SQL - 조건문 (CASE)

### 1. CASE 문의 개념

SQL의 `CASE` 문은 프로그래밍 언어의 `if-else` 또는 `switch` 문과 유사. 특정 조건에 따라 서로 다른 결과값을 반환하고 싶을 때 사용하며, 주로 `SELECT` 절에서 데이터를 가공하는 용도로 쓰임.

<br>

### 2. CASE 문의 기본 문법

```sql
CASE 
    WHEN 조건1 THEN 결과1
    WHEN 조건2 THEN 결과2
    ELSE 결과3
END AS 별칭
```

* **WHEN**: 조건을 정의.
* **THEN**: 해당 조건이 참일 때 반환할 값을 정의.
* **ELSE**: 앞선 모든 조건에 해당하지 않을 때 반환할 기본값. (생략 시 NULL 반환)
* **END**: CASE 문이 끝났음을 알림.

<br>

### 3. 주요 활용 사례 
| 활용 형태 | 설명 | 사용 예시 (Example) |
| --- | --- | --- |
| **단순 값 분류** | 특정 값에 따라 명칭 부여 | `CASE WHEN status = 'READY' THEN '배송준비' ... END` |
| **범위 분류** | 수치 범위를 기준으로 등급 산정 | `CASE WHEN price >= 100000 THEN '고가' ELSE '저가' END` |
| **NULL 처리** | NULL인 경우를 조건으로 처리 | `CASE WHEN phone IS NULL THEN '연락처없음' ELSE phone END` |

<br>

### 4. CASE 문 사용 시 주의사항

1. **순서의 중요성**: 위에서부터 순차적으로 조건을 검사. 첫 번째로 만족하는 `WHEN` 절의 결과만 반환하고 종료되므로, 범위가 겹친다면 더 좁은 범위나 중요한 조건을 앞에 배치해야함.
2. **데이터 타입의 일치**: 모든 `THEN` 뒤에 오는 결과값들은 서로 동일한(혹은 호환 가능한) 데이터 타입이어야함.
3. **별칭 사용 권장**: `END` 뒤에 `AS`를 사용해 별칭을 붙이지 않으면 결과 테이블의 컬럼명이 너무 길고 복잡해지므로 반드시 별칭을 지정하는 것이 좋음.

<br>

### 5. 시나리오별 사용 예시 (Scenario & Example)

* **범위 분류 (Grade)**: "상품 가격대에 따라 등급(저가, 중가, 고가) 부여"
```sql
SELECT name, price,
       CASE 
           WHEN price >= 100000 THEN '고가'
           WHEN price >= 50000  THEN '중가'
           ELSE '저가'
       END AS price_grade
FROM product;

```
<br>

* **상태값 한글화**: "영문 상태 코드를 사용자 화면용 한글 명칭으로 변환"
```sql
SELECT order_id,
       CASE status
           WHEN 'PAYMENT_COMPLETE' THEN '결제완료'
           WHEN 'SHIPPING'         THEN '배송중'
           WHEN 'DELIVERED'        THEN '배송완료'
           ELSE '기타'
       END AS status_kor
FROM orders;

```
<br>

* **조건 기반 집계 (Pivot 효과)**: "회원별 주문 건수를 집계할 때 특정 조건(취소 여부)을 분리하여 계산"
```sql
-- 총 주문 건수와 별개로 취소된 주문만 따로 카운트함
SELECT member_id,
       COUNT(*) AS total_cnt,
       COUNT(CASE WHEN status = 'CANCEL' THEN 1 END) AS cancel_cnt
FROM orders
GROUP BY member_id;

```
<br>

* **NULL 데이터 가공**: "연락처가 없는 경우 기본 문구로 대체하여 노출"
```sql
SELECT name,
       CASE 
           WHEN phone IS NULL THEN '연락처 미등록'
           ELSE phone
       END AS contact_info
FROM member;

```
<br>

### 6. 실무 포인트

* **어디서 처리할 것인가?**: 복잡한 비즈니스 로직을 DB의 `CASE` 문으로 모두 처리하기보다는, 상황에 따라 **애플리케이션(Java/Spring 등)**에서 처리하는 것과 적절히 분배하는 것이 중요.
* **가독성 유지**: 너무 복잡한 다중 `CASE` 문은 가독성을 해치므로, 복잡도가 높다면 서브쿼리나 인라인 뷰를 활용해 데이터를 정제한 뒤 사용하는 것을 고려해야함.