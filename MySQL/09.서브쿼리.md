# SQL - 서브쿼리 (Subquery)

### 1. 서브쿼리의 개념

서브쿼리는 메인 쿼리 안에 포함된 '하위 쿼리'를 말함. 보통 복잡한 조건을 한 번에 해결하기 위해 사용하며, 이를 **"쿼리 안의 쿼리"**라고 함.

<br>

### 2. 위치에 따른 서브쿼리 분류
| 분류 | 위치 (Clause) | 주요 특징 | 사용 예시 (Example) |
| --- | --- | --- | --- |
| **중첩 서브쿼리** | `WHERE` 절 | 가장 일반적인 형태. 조건 값을 동적으로 결정. | `WHERE price > (SELECT AVG(price) FROM ...)` |
| **인라인 뷰** | `FROM` 절 | 서브쿼리 결과를 가상 테이블로 취급. **별칭 필수.** | `FROM (SELECT ... ) AS temp` |
| **스칼라 서브쿼리** | `SELECT` 절 | 결과가 반드시 **1행 1열**이어야 함. 컬럼처럼 사용. | `SELECT name, (SELECT ... ) FROM ...` |

<br>

### 3. 서브쿼리 연산자 (다중 행 처리)

서브쿼리의 결과가 여러 개일 때 사용하는 연산자들.

* **IN**: 서브쿼리 결과 중 하나라도 일치하면 참. (가장 많이 사용)
* **ANY / SOME**: 결과 중 하나라도 조건을 만족하면 참. (보통 `> ANY`는 '최솟값보다 크면'의 의미)
* **ALL**: 결과의 모든 값을 만족해야 참. (보통 `> ALL`은 '최댓값보다 크면'의 의미)
* **EXISTS**: 서브쿼리 결과가 하나라도 존재하면 참. (성능 최적화 시 강조됨)

<br>

### 4. 상관 서브쿼리 (Correlated Subquery)

메인 쿼리의 값을 서브쿼리 내부로 가져와서 비교하는 방식.

* **동작 방식**: 메인 쿼리 한 행 읽기 → 해당 행의 값을 서브쿼리에 전달 → 서브쿼리 실행 → 결과 비교.
* **포인트**: "외부 쿼리의 컬럼을 안쪽에서 사용하느냐"가 판단 기준이므로. 성능에 영향을 줄 수 있으므로 주의 깊게 사용해야함.

<br>

### 5. 시나리오별 사용 예시 (Scenario & Example)

* **중첩 서브쿼리 (WHERE)**: "평균 가격보다 비싼 상품만 조회"
```sql
SELECT name, price FROM product
WHERE price > (SELECT AVG(price) FROM product);

```
<br>

* **인라인 뷰 (FROM)**: "카테고리별 최고가를 구한 뒤, 그중 100만 원 넘는 것만 필터링"
```sql
SELECT temp.category, temp.max_price
FROM (SELECT category, MAX(price) AS max_price FROM product GROUP BY category) AS temp
WHERE temp.max_price >= 1000000;

```
<br>

* **스칼라 서브쿼리 (SELECT)**: "상품 목록 옆에 각각의 총 주문 횟수를 붙여서 출력"
```sql
SELECT p.name, 
       (SELECT COUNT(*) FROM orders o WHERE o.product_id = p.id) AS order_cnt
FROM product p;

```
<br>

* **상관 서브쿼리 (EXISTS)**: "주문 기록이 한 번이라도 있는 회원만 조회"
```sql
SELECT m.name FROM member m
WHERE EXISTS (SELECT 1 FROM orders o WHERE o.member_id = m.id);

```

<br>

### 6. 최종 요약 및 주의사항 (Summary)

1. **인라인 뷰의 별칭**: `FROM` 절에서 서브쿼리 사용 시 반드시 `AS 별칭`을 지정해야 함. 미지정 시 에러 발생함.
2. **서브쿼리 vs 조인**: 대부분의 서브쿼리는 `JOIN`으로 변경 가능함. 데이터 양이 많을 때는 성능상 유리한 `JOIN` 사용을 우선 고려해야 함.
3. **스칼라 서브쿼리의 성능**: `SELECT` 절 서브쿼리는 메인 쿼리 행 수만큼 반복 실행될 수 있어 대량 데이터 처리 시 성능 저하의 원인이 될 수 있으므로 남용을 주의해야함.
4. **반드시 1행 1열**: 스칼라 서브쿼리는 결과값이 반드시 하나여야 함. 서브쿼리 결과가 2행 이상일 경우 런타임 에러 발생함.