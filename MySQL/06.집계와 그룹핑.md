# SQL - 집계와 그룹핑

### 집계 함수 (Aggregate Functions)

여러 행의 데이터를 모아 하나의 결과값(통계치)을 만들어내는 함수.

| 함수명 | 설명 | 사용 예시 (Example) |
| --- | --- | --- |
| **COUNT** | 행의 개수를 세기 (NULL 제외 선택 가능) | `SELECT COUNT(*) FROM orders ` |
| **SUM** | 숫자 컬럼의 합계를 계산 | `SELECT SUM(price * quantity) FROM order_stat;` |
| **AVG** | 숫자 컬럼의 평균을 계산 | `SELECT AVG(price) FROM order_stat;` |
| **MAX / MIN** | 최댓값 / 최솟값을 찾기 | `SELECT MAX(price), MIN(price) FROM order_stat;` |
| **DISTINCT** | 중복을 제거하고 집계 (COUNT와 조합) | `SELECT COUNT(DISTINCT customer_name) FROM order_stat;` |

* **주의**: `COUNT(*)`은 NULL을 포함한 전체 행을 세지만, `COUNT(컬럼명)`은 해당 컬럼이 NULL인 행은 제외하고 계산.

<br>

### 그룹화 (GROUP BY)

특정 컬럼을 기준으로 데이터를 그룹으로 묶어 그룹별 통계를 낼 때 사용.

| 기능 | 명령어 (Syntax) | 사용 예시 (Example) |
| --- | --- | --- |
| **단일 컬럼 그룹화** | `GROUP BY [컬럼];` | `SELECT category, SUM(price) FROM order_stat GROUP BY category;` |
| **다중 컬럼 그룹화** | `GROUP BY [컬1], [컬2];` | `GROUP BY customer_name, category; (고객별+카테고리별)` |

<br>

### 그룹 필터링 (HAVING 절)

`WHERE` 절이 개별 행을 필터링한다면, `HAVING` 절은 **그룹화된 결과(집계 결과)**에 대한 조건을 걸 때 사용합.

| 절 | 필터링 대상 | 사용 예시 (Example) |
| --- | --- | --- |
| **WHERE** | 그룹화 전 전체 데이터 | `WHERE price >= 10000; (만 원 이상 상품만 골라서 그룹화)` |
| **HAVING** | 그룹화 후 집계된 결과 | `HAVING COUNT(*) >= 2; (주문 건수가 2건 이상인 그룹만 추출)` |

<br>

### SQL 실행 순서 (Select Execution Order)

SQL 문법은 작성 순서와 데이터베이스 내부에서 처리되는 실행 순서가 다릅니다. 이 순서를 이해해야 정확한 쿼리 작성이 가능.

1. **FROM**: 대상 테이블을 먼저 확인.
2. **WHERE**: 그룹화하기 전에 개별 행을 먼저 필터링.
3. **GROUP BY**: 남은 데이터를 특정 기준에 따라 그룹으로 분류.
4. **HAVING**: 그룹화된 통계 결과에 조건을 걸어 필터링.
5. **SELECT**: 최종적으로 어떤 컬럼(또는 집계값)을 보여줄지 결정.
6. **ORDER BY**: 결과를 정렬.
7. **LIMIT**: 정해진 개수만큼만 출력.

<br>

### 핵심 요약 및 주의사항

* **GROUP BY의 제약**: `GROUP BY`를 사용할 때 `SELECT` 절에는 그룹화의 기준이 된 컬럼이나 집계 함수(`SUM`, `COUNT` 등)만 올 수 있습니다. 기준 외의 일반 컬럼을 넣으면 부정확한 데이터가 조회될 수 있음.
* **NULL의 그룹화**: `GROUP BY` 수행 시 해당 컬럼이 `NULL`인 행들도 하나의 독립된 그룹으로 묶여 집계됨.
* **HAVING vs WHERE**: 집계 함수 결과에 조건을 걸어야 한다면 무조건 `HAVING`을 사용해야함. (예: `WHERE SUM(price) > 100`은 문법 오류.)