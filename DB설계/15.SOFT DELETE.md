# Soft Delete (논리 삭제)

### 1. Soft Delete vs Hard Delete

데이터를 삭제하는 방식은 크게 두 가지로 나뉨.

| 구분 | Hard Delete (물리 삭제) | Soft Delete (논리 삭제) |
| --- | --- | --- |
| **방법** | `DELETE` 쿼리로 데이터 완전 삭제 | `UPDATE` 쿼리로 삭제 상태만 변경 |
| **특징** | 저장 공간 절약, 구현 단순 | **데이터 복구 가능**, 이력 보존 |
| **실무 활용** | 개인정보 파기 등 법적 의무 시 | 주문, 게시글 등 비즈니스 데이터 |

<br>

### 2. 주요 설계 방식

Soft Delete를 구현하기 위해 테이블에 상태를 나타내는 컬럼을 추가함.

* **방식 1: 삭제 여부(Y/N)**
* 컬럼: `is_deleted` (Boolean/Char)
* 설명: 삭제되면 'Y', 정상은 'N'.


* **방식 2: 삭제 일시 (권장)**
* 컬럼: `deleted_at` (Datetime)
* 설명: 삭제된 시간을 기록. 값이 `NULL`이면 미삭제, 값이 있으면 삭제된 데이터로 간주.
* **장점**: 삭제 여부뿐만 아니라 **"언제 삭제되었는지"**까지 알 수 있어 활용도가 훨씬 높음.

<br>

### 3. Soft Delete의 영향 (주의사항)

논리 삭제를 도입하면 모든 쿼리에서 데이터 노출 범위를 신경 써야함.

1. **조회(SELECT) 시 필터링**: 모든 조회 쿼리에 `WHERE deleted_at IS NULL` 조건이 붙어야함. (실수하면 삭제된 데이터가 노출되는 대형 사고 발생)
2. **UNIQUE 제약 조건 충돌**:
* 아이디가 `user1`인 회원이 탈퇴(Soft Delete)한 후, 새로운 회원이 `user1`으로 가입하려 할 때 문제가 생김.
* **해결**: UNIQUE 인덱스에 `deleted_at`을 포함하거나, 삭제 시 식별값을 변경(예: `user1_deleted_20231001`)하는 처리가 필요함.

<br>

### 4. 참조 무결성과 Soft Delete

외래 키(FK) 관계에 있는 부모-자식 테이블에서 삭제 처리가 까다로워짐.

* 부모(게시글)가 Soft Delete 되면 자식(댓글)들도 조회되지 않도록 **애플리케이션 단에서 연쇄 처리**를 하거나, 자식들도 일괄 Soft Delete 상태로 바꿔야함.
* DB의 `ON DELETE CASCADE`는 물리 삭제용이므로 Soft Delete에서는 직접 로직을 짜야함.

<br>

### 5. 시나리오별 사용 예시 (Scenario & Example)

* **상태 컬럼 기반 Soft Delete**: "게시글 삭제 처리 시 삭제 일시 기록"
```sql
-- [기존] DELETE FROM posts WHERE post_id = 101; (복구 불가)
-- [개선] 현재 시간을 기록하여 삭제된 것으로 간주
UPDATE posts 
SET deleted_at = NOW() 
WHERE post_id = 101;

-- 조회 시 반드시 NULL 체크 필수
SELECT * FROM posts WHERE deleted_at IS NULL;

```
<br>

* **UNIQUE 제약 조건 충돌 해결**: "탈퇴한 아이디로 재가입 허용하기"
```sql
-- 아이디(username)와 삭제일시(deleted_at)를 묶어서 복합 UNIQUE 인덱스 설정
-- 삭제되지 않은 상태(NULL)는 단 하나만 존재 가능, 삭제된 값은 시각이 다르므로 중복 허용됨
CREATE UNIQUE INDEX uidx_username_deleted_at ON member(username, deleted_at);

```
<br>

* **참조 무결성 연쇄 처리**: "게시글 삭제 시 댓글 노출 차단"
```sql
-- 부모(Post)만 Soft Delete 하고, 조인 시 부모의 삭제 여부를 확인하여 자식 노출 결정
SELECT c.* FROM comments c
JOIN posts p ON c.post_id = p.post_id
WHERE p.deleted_at IS NULL; 

```
<br>

* **배치 작업을 통한 영구 삭제**: "법적 보관 기간이 지난 데이터 파기"
```sql
-- Soft Delete 된 지 5년이 지난 데이터는 Hard Delete 하여 개인정보 보호법 준수
DELETE FROM member 
WHERE deleted_at < DATE_SUB(NOW(), INTERVAL 5 YEAR);

```

<br>

### 6. 실무 포인트

* **글로벌 필터(Global Filter)**: JPA(Hibernate)의 `@Where`나 `@SQLDelete` 같은 기능을 활용하면, 개발자가 수동으로 `WHERE` 절을 붙이지 않아도 자동으로 삭제된 데이터를 제외해줌. 실무에서는 이 방식을 강력 권장함.

* **인덱스 성능**: 삭제된 데이터가 전체의 90% 이상을 차지한다면, `deleted_at IS NULL` 조건이 인덱스 효율을 떨어뜨릴 수 있으며, 이 경우 오래된 삭제 데이터는 주기적으로 별도의 백업 테이블로 옮기고 실제 테이블에서는 지우는 전략이 필요함.
* **개인정보 보호법**: Soft Delete로 데이터를 남겨두더라도, 법적으로 정해진 보유 기간이 지나면 반드시 **Hard Delete**를 통해 영구 파기해야 한다는 점을 잊으면 안됨.